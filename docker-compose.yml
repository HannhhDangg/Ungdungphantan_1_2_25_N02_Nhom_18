version: "3.8"

networks:
  app-network:
    driver: bridge

services:
  # =========================================================
  # 0. LOAD BALANCER TỔNG (NGINX) - MỚI THÊM VÀO
  # =========================================================
  nginx:
    image: nginx:latest
    container_name: lb-nginx
    restart: always
    ports:
      - "80:80" # Nginx chiếm cổng 80 để đón khách
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - kong
      - frontend
    networks:
      - app-network

  # =========================================================
  # 1. API GATEWAY (KONG) - ĐÃ SỬA PORT
  # =========================================================
  kong:
    image: kong:3.4
    container_name: api-gateway
    restart: always
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong.yml
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_LISTEN=0.0.0.0:8000
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
    ports:
      # - "80:8000" <--- QUAN TRỌNG: ĐÃ XÓA DÒNG NÀY (Để nhường cổng 80 cho Nginx)
      - "8001:8001" # Giữ cổng Admin để debug nếu cần
    volumes:
      - ./kong/kong.yml:/usr/local/kong/declarative/kong.yml
    networks:
      - app-network

  # =========================================================
  # 2. BACKEND SERVICES
  # =========================================================
  auth_service:
    build: ./auth_service
    restart: always
    environment:
      - PORT=3000
      - DB_HOST=haproxy
      - DB_PORT=5000
      - DB_USER=postgres
      - DB_PASSWORD=rootpassword
      - DB_NAME=leave_management
      - MONGO_URI=mongodb://mongo-1:27017,mongo-2:27017,mongo-3:27017/logs_db?replicaSet=rs0&readPreference=secondaryPreferred
      - REDIS_HOST=redis
      - JWT_SECRET=secret_key_cua_ban
    depends_on:
      - haproxy
      - mongo-init
      - redis
    networks:
      - app-network

  leave_service:
    build: ./leave_service
    restart: always
    environment:
      - PORT=3000
      - DB_HOST=haproxy
      - DB_PORT=5000
      - DB_USER=postgres
      - DB_PASSWORD=rootpassword
      - DB_NAME=leave_management
      - MONGO_URI=mongodb://mongo-1:27017,mongo-2:27017,mongo-3:27017/logs_db?replicaSet=rs0&readPreference=secondaryPreferred
      - REDIS_HOST=redis
      - JWT_SECRET=secret_key_cua_ban
    volumes:
      - ./leave_service:/app
      - ./leave_service/uploads:/app/uploads
    depends_on:
      - haproxy
      - mongo-init
    networks:
      - app-network

  frontend:
    build: ./frontend
    environment:
      # SỬA LẠI: URL API phải trỏ về Nginx (cổng 80) hoặc trực tiếp Kong nếu Nginx lỗi
      - REACT_APP_API_URL=http://localhost:80
    # XÓA DÒNG "command: ..." cũ đi, vì file vite.config.js đã tự lo rồi
    ports:
      - "3000:3000" # Mở cổng 3000 ra máy ngoài để test
    # --- THÊM PHẦN NÀY ĐỂ ĐỒNG BỘ CODE ---
    volumes:
      - ./frontend:/app
      - /app/node_modules
    # -------------------------------------
    stdin_open: true
    tty: true
    networks:
      - app-network

  # =========================================================
  # 3. POSTGRES HA (PATRONI + ETCD + HAPROXY)
  # =========================================================
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    command: etcd -advertise-client-urls http://etcd:2379 -listen-client-urls http://0.0.0.0:2379
    networks:
      - app-network

  postgres-1:
    image: registry.opensource.zalan.do/acid/spilo-15:3.0-p1
    container_name: postgres-1
    environment:
      - SCOPE=leave-cluster
      - ETCD3_HOSTS=etcd:2379
      - POSTGRES_PASSWORD=rootpassword
      - PATRONI_NAME=pg1
      - SPILO_PROVIDER=local
    ports:
      - "5432"
    depends_on:
      - etcd
    networks:
      - app-network

  postgres-2:
    image: registry.opensource.zalan.do/acid/spilo-15:3.0-p1
    container_name: postgres-2
    environment:
      - SCOPE=leave-cluster
      - ETCD3_HOSTS=etcd:2379
      - POSTGRES_PASSWORD=rootpassword
      - PATRONI_NAME=pg2
      - SPILO_PROVIDER=local
    ports:
      - "5432"
    depends_on:
      - etcd
    networks:
      - app-network

  postgres-3:
    image: registry.opensource.zalan.do/acid/spilo-15:3.0-p1
    container_name: postgres-3
    environment:
      - SCOPE=leave-cluster
      - ETCD3_HOSTS=etcd:2379
      - POSTGRES_PASSWORD=rootpassword
      - PATRONI_NAME=pg3
      - SPILO_PROVIDER=local
    ports:
      - "5432"
    depends_on:
      - etcd
    networks:
      - app-network

  haproxy:
    image: haproxy:2.4
    container_name: pg-lb
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "5000:5000"
      - "5001:5001"
      - "7000:7000"
    depends_on:
      - postgres-1
      - postgres-2
      - postgres-3
    networks:
      - app-network

  # =========================================================
  # 4. MONGODB REPLICA SET (HA)
  # =========================================================
  mongo-1:
    image: mongo:6.0
    container_name: mongo-1
    command: ["--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017"
    networks:
      - app-network

  mongo-2:
    image: mongo:6.0
    container_name: mongo-2
    command: ["--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017"
    networks:
      - app-network

  mongo-3:
    image: mongo:6.0
    container_name: mongo-3
    command: ["--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017"
    networks:
      - app-network

  mongo-init:
    image: mongo:6.0
    depends_on:
      - mongo-1
      - mongo-2
      - mongo-3
    command: >
      mongosh --host mongo-1:27017 --eval 
      'rs.initiate({
        _id: "rs0",
        members: [
          { _id: 0, host: "mongo-1:27017" },
          { _id: 1, host: "mongo-2:27017" },
          { _id: 2, host: "mongo-3:27017" }
        ]
      })'
    networks:
      - app-network

  # =========================================================
  # 5. REDIS
  # =========================================================
  redis:
    image: redis:alpine
    container_name: broker-redis
    ports:
      - "6379:6379"
    restart: always
    networks:
      - app-network
