events {
    worker_connections 1024;
}

http {
    # --- 1. Nhóm Frontend (Giữ nguyên) ---
    upstream frontend_upstream {
        server frontend:3000; 
    }

    # --- 2. Nhóm Kong API Gateway (MỚI) ---
    # Thay vì định nghĩa auth_service, leave_service ở đây
    # Ta chỉ cần định nghĩa Kong. Kong sẽ tự biết đường đi tiếp.
    upstream kong_upstream {
        server kong:8000;
    }

    server {
        listen 80;

        # =============================================================
        # KHU VỰC 1: CÁC REQUEST CẦN XỬ LÝ API/DỮ LIỆU -> ĐẨY VỀ KONG
        # =============================================================

        # 1. Tất cả các API (/api/auth_ser, /api/users, /api/otp...)
        # Thay vì viết 5-6 cái location lẻ tẻ, ta gom hết vào đây.
        # Kong sẽ đọc file kong.yml để biết phân loại tiếp.
        location /api/ {
            proxy_pass http://kong_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 2. Xem ảnh (Uploads) -> Đẩy về Kong
        location /uploads/ {
            proxy_pass http://kong_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 3. Socket.io -> Đẩy về Kong (Cần cấu hình WebSocket)
        location /socket.io/ {
            proxy_pass http://kong_upstream;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # =============================================================
        # KHU VỰC 2: CÁC REQUEST GIAO DIỆN -> ĐẨY VỀ FRONTEND
        # =============================================================

        # 4. Trang chủ và React Router
        location / {
            proxy_pass http://frontend_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # WebSocket cho React Hot Reload (khi dev)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}